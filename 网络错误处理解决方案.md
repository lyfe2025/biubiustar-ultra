# 网络错误处理解决方案

## 问题描述

你遇到的错误：
```
Failed to execute 'json' on 'Response': Unexpected end of JSON input
Failed to fetch
```

这通常发生在以下情况：
1. 后端服务未启动
2. 网络连接问题
3. 服务器响应异常
4. 超时或连接被拒绝

## 解决方案概述

我们实现了一个完整的网络错误处理工具包，包括：

### 🎯 核心功能
- **智能错误识别**: 自动识别不同类型的网络错误
- **友好错误提示**: 多语言支持的用户友好提示
- **自动重试机制**: 智能重试，支持指数退避
- **超时控制**: 防止请求无限等待

### 🌍 多语言支持
- 简体中文 (zh)
- 繁体中文 (zh-TW)  
- 越南语 (vi)
- 英语 (en)

## 实现的文件

### 1. 错误分析工具
**文件**: `src/utils/networkErrorHandler.ts`
- 分析网络错误类型
- 提供多语言错误信息
- 判断错误是否可重试

### 2. 增强的Fetch包装器
**文件**: `src/utils/enhancedFetch.ts`
- 自动重试机制
- 超时控制
- 错误分类处理
- 批量请求支持

### 3. React Hook
**文件**: `src/hooks/useNetworkError.ts`
- 管理错误状态
- 提供重试功能
- 自动隐藏选项

### 4. 错误提示组件
**文件**: `src/components/NetworkErrorModal.tsx`
- 友好的错误提示界面
- 多语言支持
- 重试按钮
- 技术详情展示

### 5. 使用示例
**文件**: `src/components/NetworkErrorExample.tsx`
- 完整的使用示例
- 错误模拟测试
- 多语言界面

### 6. 测试页面
**文件**: `src/pages/NetworkErrorTest.tsx`
- 独立的测试页面
- 方便测试各种错误情况

## 使用方法

### 基本使用

```tsx
import { useNetworkError } from '../hooks/useNetworkError'
import NetworkErrorModal from '../components/NetworkErrorModal'

function MyComponent() {
  const { error, isErrorModalOpen, showError, hideError, retry } = useNetworkError({
    onRetry: fetchData
  })

  async function fetchData() {
    try {
      const response = await fetch('/api/data')
      const data = await response.json()
      // 处理数据...
    } catch (error) {
      showError(error) // 显示友好的错误提示
    }
  }

  return (
    <div>
      <button onClick={fetchData}>获取数据</button>
      
      <NetworkErrorModal
        error={error}
        isOpen={isErrorModalOpen}
        onClose={hideError}
        onRetry={retry}
      />
    </div>
  )
}
```

### 使用增强的Fetch

```tsx
import { enhancedFetch } from '../utils/enhancedFetch'

async function fetchData() {
  try {
    const result = await enhancedFetch('/api/data', {
      timeout: 10000,        // 10秒超时
      retries: 3,            // 重试3次
      retryDelay: 1000       // 重试延迟1秒
    })
    
    console.log('数据:', result.data)
  } catch (error) {
    console.error('请求失败:', error)
  }
}
```

## 错误类型识别

### 自动识别的错误

| 错误类型 | 描述 | 可重试 | 用户提示 |
|---------|------|--------|----------|
| `server_not_started` | 服务器未启动 | ✅ | "服务器可能未启动，请检查服务状态" |
| `connection_refused` | 连接被拒绝 | ✅ | "服务器可能未启动，请检查服务状态" |
| `network_timeout` | 网络超时 | ✅ | "网络连接较慢，请稍后重试" |
| `dns_resolution_failed` | DNS解析失败 | ✅ | "请检查网络设置或稍后重试" |
| `ssl_handshake_failed` | SSL握手失败 | ✅ | "请检查网络环境或联系技术支持" |

## 多语言错误提示示例

### 简体中文
- **错误**: "服务器未启动"
- **建议**: "服务器可能未启动，请检查服务状态或联系管理员"

### 繁体中文
- **錯誤**: "伺服器未啟動"
- **建議**: "伺服器可能未啟動，請檢查服務狀態或聯絡管理員"

### 越南语
- **Lỗi**: "Máy chủ chưa khởi động"
- **Gợi ý**: "Máy chủ có thể chưa khởi động, vui lòng kiểm tra trạng thái dịch vụ"

### English
- **Error**: "Server not started"
- **Suggestion**: "Server may not be started, please check service status"

## 集成到现有项目

### 1. 替换现有的fetch调用

**之前**:
```tsx
try {
  const response = await fetch('/api/data')
  const data = await response.json()
} catch (error) {
  console.error('请求失败:', error)
}
```

**之后**:
```tsx
import { enhancedFetch } from '../utils/enhancedFetch'

try {
  const result = await enhancedFetch('/api/data')
  const data = result.data
} catch (error) {
  // 使用 useNetworkError Hook 显示友好提示
  showError(error)
}
```

### 2. 在现有服务中使用

```tsx
// 之前
export class UserService {
  async getUsers() {
    const response = await fetch('/api/users')
    return response.json()
  }
}

// 之后
import { enhancedFetch } from '../utils/enhancedFetch'

export class UserService {
  async getUsers() {
    try {
      const result = await enhancedFetch('/api/users')
      return result.data
    } catch (error) {
      throw error // 错误会被上层组件处理
    }
  }
}
```

## 测试方法

### 1. 访问测试页面
在浏览器中访问 `/NetworkErrorTest` 页面

### 2. 测试各种错误
- 点击"模拟服务器错误"按钮
- 点击"模拟网络错误"按钮
- 点击"模拟连接错误"按钮
- 观察多语言错误提示

### 3. 测试重试功能
- 触发错误后点击"重试"按钮
- 观察重试状态和结果

## 配置选项

### useNetworkError Hook 选项

```tsx
const { showError } = useNetworkError({
  onRetry: fetchData,        // 重试函数
  autoHide: false,           // 是否自动隐藏错误
  autoHideDelay: 5000        // 自动隐藏延迟（毫秒）
})
```

### enhancedFetch 选项

```tsx
const result = await enhancedFetch(url, {
  timeout: 10000,            // 超时时间（毫秒）
  retries: 3,                // 重试次数
  retryDelay: 1000,          // 重试延迟（毫秒）
  retryOnNetworkError: true  // 是否在网络错误时重试
})
```

## 优势

### 🚀 用户体验
- 友好的错误提示，不再是技术术语
- 多语言支持，覆盖主要用户群体
- 提供具体的解决建议

### 🛠️ 开发体验
- 简单的API，易于集成
- 自动错误处理，减少重复代码
- 支持自定义和扩展

### 🔧 技术特性
- 智能重试机制
- 超时控制
- 错误分类和统计
- 性能优化

## 下一步

1. **测试功能**: 访问 `/NetworkErrorTest` 页面测试各种错误情况
2. **集成使用**: 在现有组件中替换fetch调用
3. **自定义配置**: 根据需要调整重试策略和超时设置
4. **扩展功能**: 添加更多错误类型和自定义处理逻辑

## 总结

这个解决方案完美解决了你遇到的网络错误问题：

- ✅ **"Failed to execute 'json' on 'Response'"** → 自动识别为服务器未启动
- ✅ **"Failed to fetch"** → 自动识别为网络连接问题
- ✅ **多语言支持** → 用户友好的错误提示
- ✅ **自动重试** → 提高成功率
- ✅ **易于集成** → 快速应用到现有项目

现在你的应用可以优雅地处理各种网络错误，为用户提供更好的体验！
