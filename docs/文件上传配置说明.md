# 📁 文件上传配置说明

## 🎯 配置概览

你的项目支持多种文件上传场景，每种场景都有不同的配置限制。这些配置需要与前端显示保持一致，确保用户体验的一致性。

## 📊 上传配置详情

### 1. 🚀 帖子发布 (Posts)
```typescript
// 配置位置: api/utils/uploadSecurity.ts
posts: {
  maxFileSize: 50 * 1024 * 1024, // 50MB
  maxFiles: 9,                    // 最多9个文件
  allowedTypes: 'both',           // 支持图片和视频
  uploadPath: 'public/uploads/posts'
}
```

**前端显示**: "支持图片和视频，最多9个文件，单个文件最大50MB"

**支持的文件类型**:
- **图片**: JPEG, PNG, GIF, WebP
- **视频**: MP4
- **文件数量**: 最多9个文件
- **单个文件大小**: 最大50MB

### 2. 👤 头像上传 (Avatar)
```typescript
avatar: {
  maxFileSize: 5 * 1024 * 1024,  // 5MB
  maxFiles: 1,                    // 最多1个文件
  allowedTypes: 'image',          // 仅支持图片
  uploadPath: 'public/uploads/avatars'
}
```

**支持的文件类型**:
- **图片**: JPEG, PNG, GIF, WebP
- **文件数量**: 最多1个文件
- **单个文件大小**: 最大5MB

### 3. 🎉 活动图片 (Activities)
```typescript
activities: {
  maxFileSize: 10 * 1024 * 1024, // 10MB
  maxFiles: 3,                    // 最多3个文件
  allowedTypes: 'image',          // 仅支持图片
  uploadPath: 'public/uploads/activities'
}
```

**支持的文件类型**:
- **图片**: JPEG, PNG, GIF, WebP
- **文件数量**: 最多3个文件
- **单个文件大小**: 最大10MB

## 🔧 配置文件位置

### 1. 环境变量配置 (.env)
```bash
# 全局文件上传配置
UPLOAD_MAX_SIZE=52428800       # 50MB (全局最大限制)
UPLOAD_ALLOWED_TYPES=image/jpeg,image/png,image/gif,image/webp,video/mp4
```

**注意**: 这个配置是全局最大限制，实际的上传限制由具体业务逻辑控制。

### 2. 业务逻辑配置 (api/utils/uploadSecurity.ts)
```typescript
export const DEFAULT_UPLOAD_CONFIGS = {
  posts: { /* 帖子配置 */ },
  avatar: { /* 头像配置 */ },
  activities: { /* 活动配置 */ }
}
```

**注意**: 这是实际生效的配置，修改后需要重启服务。

### 3. 前端显示配置 (src/contexts/language/translations/)
```typescript
// 中文
uploadDescription: '支持图片和视频，最多9个文件，单个文件最大50MB'

// 英文
uploadDescription: 'Supports images and videos, up to 9 files, single file max 50MB'

// 繁体中文
uploadDescription: '支持圖片和視頻，最多9個文件，單個文件最大50MB'

// 越南语
uploadDescription: 'Hỗ trợ hình ảnh và video, tối đa 9 file, file lớn nhất 50MB'
```

## ⚠️ 配置一致性要求

### 1. 必须保持一致的配置
- **文件大小限制**: 后端验证必须与前端显示一致
- **文件数量限制**: 后端验证必须与前端显示一致
- **文件类型支持**: 后端验证必须与前端显示一致

### 2. 配置修改流程
```bash
# 1. 修改后端配置
# 文件: api/utils/uploadSecurity.ts
maxFileSize: 100 * 1024 * 1024, // 改为100MB

# 2. 修改前端显示
# 文件: src/contexts/language/translations/posts.ts
uploadDescription: '支持图片和视频，最多9个文件，单个文件最大100MB'

# 3. 修改环境变量
# 文件: .env
UPLOAD_MAX_SIZE=104857600       # 100MB

# 4. 重启服务
npm restart
```

## 🔍 配置验证

### 1. 后端验证
```typescript
// 文件大小验证
if (!this.validateFileSize(file.size, maxSize)) {
  return { isValid: false, error: `文件大小超出限制（最大${Math.round(maxSize / 1024 / 1024)}MB）` }
}

// 文件类型验证
if (!this.isMimeTypeAllowed(file.mimetype)) {
  return { isValid: false, error: '不支持的文件格式' }
}

// 文件数量验证
if (files.length > maxFiles) {
  return { isValid: false, error: `文件数量过多（最多${maxFiles}个）` }
}
```

### 2. 前端验证
```typescript
// 文件大小检查
if (file.size > maxFileSize) {
  setError(`文件过大，最大支持${Math.round(maxFileSize / 1024 / 1024)}MB`)
  return
}

// 文件数量检查
if (uploadedFiles.length >= maxFiles) {
  setError(`最多只能上传${maxFiles}个文件`)
  return
}

// 文件类型检查
if (!allowedTypes.includes(file.type)) {
  setError('不支持的文件类型')
  return
}
```

## 🚨 常见问题

### 1. 配置不一致问题
**问题**: 前端显示"最大50MB"，但实际只能上传10MB
**原因**: `.env` 文件中的 `UPLOAD_MAX_SIZE` 设置过小
**解决**: 修改 `.env` 文件，确保 `UPLOAD_MAX_SIZE >= 50MB`

### 2. 文件类型不支持
**问题**: 上传特定格式文件时提示"不支持的文件类型"
**原因**: 后端 `allowedTypes` 配置不包含该格式
**解决**: 在 `uploadSecurity.ts` 中添加支持的文件类型

### 3. 文件数量限制
**问题**: 上传超过限制数量的文件时提示"文件数量过多"
**原因**: 后端 `maxFiles` 配置过小
**解决**: 根据业务需求调整 `maxFiles` 配置

## 📝 配置最佳实践

### 1. 配置管理原则
- **一致性**: 前后端配置必须保持一致
- **安全性**: 文件类型和大小限制要合理
- **用户体验**: 限制要符合用户实际需求
- **性能考虑**: 大文件会影响上传和存储性能

### 2. 配置修改建议
- **开发环境**: 可以设置较小的限制，便于测试
- **生产环境**: 根据实际业务需求和服务器性能设置
- **渐进式**: 先设置保守的限制，再根据用户反馈调整

### 3. 监控和告警
- **上传成功率**: 监控文件上传的成功率
- **文件大小分布**: 了解用户上传文件的典型大小
- **错误分析**: 分析上传失败的原因，优化配置

## 🔄 动态配置支持

### 1. 当前状态
**不支持**: 文件上传配置目前不支持通过API动态修改
**原因**: 涉及文件系统安全和业务逻辑，需要重启服务

### 2. 未来扩展
可以考虑支持以下配置的动态修改：
- 文件大小限制
- 文件数量限制
- 允许的文件类型
- 上传路径配置

### 3. 实现方式
```typescript
// 通过管理后台修改上传配置
PUT /api/admin/settings/upload
{
  "posts": {
    "maxFileSize": 100 * 1024 * 1024,
    "maxFiles": 12,
    "allowedTypes": ["image", "video"]
  }
}
```

## 📚 总结

文件上传配置是项目中重要的配置项，需要：

1. **保持一致性**: 前后端配置必须完全一致
2. **合理设置**: 根据业务需求和服务器性能设置
3. **安全考虑**: 限制文件类型和大小，防止恶意文件
4. **用户体验**: 提供清晰的错误提示和限制说明
5. **监控优化**: 持续监控上传情况，优化配置

通过正确的配置管理，可以确保文件上传功能的安全、稳定和用户友好！🚀
