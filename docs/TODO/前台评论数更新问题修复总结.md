# 前台评论数更新问题修复总结

## 问题描述
前台热门页面（Trending.tsx）和首页（Home.tsx）中，用户点击评论按钮，评论成功后关闭窗口，页面显示的帖子评论数仍然是原来的数值，没有更新。

## 问题分析

### 根本原因
1. **缓存机制问题**：`batchStatusService.batchGetCommentsCount()` 使用了缓存，评论成功后虽然清除了 `post_comments_count` 缓存，但批量缓存 `comments_count_batch_*` 没有被清除。

2. **状态同步问题**：评论成功后，`CommentModal` 只是更新了本地的评论列表，但没有通知父组件更新帖子的评论数状态。

3. **数据流断裂**：`PostCard` 组件接收的 `initialCommentsCount` 来自 `postStatusMap`，但评论成功后这个状态没有被更新。

## 修复方案

### 1. 修改 CommentModal 组件
- 添加 `onCommentSuccess` 回调属性
- 评论成功后调用回调通知父组件

```typescript
interface CommentModalProps {
  isOpen: boolean
  onClose: () => void
  postId: string
  postTitle: string
  onCommentSuccess?: (postId: string) => void // 新增
}
```

### 2. 修改 Trending.tsx 页面
- 添加 `handleCommentSuccess` 函数处理评论成功后的状态更新
- 更新 `postStatusMap` 中的评论数
- 清除相关缓存
- 传递 `onCommentSuccess` 回调给 `CommentModal`

### 3. 修改 Home.tsx 页面
- 添加类似的 `handleCommentSuccess` 函数
- 更新 `postStatusMap` 中的评论数
- 清除相关缓存

### 4. 修改 PostCard 组件
- 添加 `useEffect` 监听 `initialCommentsCount` 变化
- 确保父组件更新评论数后能正确显示

### 5. 修改 batchStatusService
- 添加 `clearPostBatchCache` 方法清除特定帖子的批量缓存

### 6. 修改 CommentService
- 在 `addComment` 方法中清除批量缓存

## 修复后的数据流

1. 用户提交评论 → `CommentModal.handleSubmitComment`
2. 评论成功 → 调用 `onCommentSuccess(postId)` 回调
3. 父组件接收回调 → 调用 `handleCommentSuccess(postId)`
4. 更新本地状态 → 调用 API 获取最新评论数，更新 `postStatusMap`
5. 清除缓存 → 调用 `batchStatusService.clearPostBatchCache(postId)`
6. PostCard 更新 → 通过 `initialCommentsCount` 属性接收更新后的评论数

## 涉及的文件

- `src/components/CommentModal.tsx` - 添加评论成功回调
- `src/pages/Trending.tsx` - 添加状态更新逻辑
- `src/pages/Home.tsx` - 添加状态更新逻辑
- `src/pages/PostDetail.tsx` - 修复评论数更新
- `src/components/PostCard.tsx` - 监听评论数变化
- `src/services/batchStatusService.ts` - 添加缓存清除方法
- `src/lib/socialService/comments.ts` - 清除批量缓存

## 测试建议

1. 在热门页面或首页点击评论按钮
2. 提交一条评论
3. 关闭评论窗口
4. 验证帖子卡片上的评论数是否正确更新
5. 检查控制台日志确认缓存清除和状态更新

## 注意事项

- 修复涉及多个页面，需要确保所有使用 `CommentModal` 的页面都传递了 `onCommentSuccess` 回调
- 缓存清除逻辑需要同时处理内存缓存和本地存储缓存
- 状态更新应该是异步的，避免阻塞用户界面
