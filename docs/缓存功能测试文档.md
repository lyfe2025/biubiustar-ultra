# 缓存功能测试文档

## 📋 测试概述

### 测试目标
验证在启用内存缓存的情况下，所有功能模块（注册、登录、个人中心、管理后台等）能够正常工作，确保缓存机制不会影响业务逻辑的正确性。

### 缓存架构说明
本项目采用多层缓存架构：
- **前端缓存**：`apiCache`（API响应缓存）、`userDataCache`（用户数据缓存）
- **后端缓存**：6种专用缓存实例，针对不同数据类型优化
- **缓存策略**：基于TTL的自动过期机制，支持手动失效

---

## 🏗️ 缓存实例说明

### 后端缓存实例配置

| 缓存实例 | 用途 | 开发环境TTL | 生产环境TTL | 最大条目数 |
|---------|------|-------------|-------------|------------|
| `userCache` | 用户信息、权限、设置 | 5分钟 | 30分钟 | 100/500 |
| `contentCache` | 帖子、活动、评论 | 2分钟 | 10分钟 | 200/1000 |
| `statsCache` | 统计数据、计数 | 30秒 | 2分钟 | 50/200 |
| `configCache` | 系统配置、多语言 | 10分钟 | 1小时 | 20/100 |
| `sessionCache` | 用户会话、临时状态 | 15分钟 | 15分钟 | 50/300 |
| `apiCache` | API响应结果 | 1分钟 | 5分钟 | 100/500 |

### 前端缓存配置

| 缓存服务 | 用途 | TTL | 存储方式 |
|---------|------|-----|----------|
| `apiCache` | API响应缓存 | 5分钟 | 内存+localStorage |
| `userDataCache` | 用户数据缓存 | 5分钟 | 内存 |

---

## 🔍 已缓存接口清单

### 用户相关接口

#### 用户基础信息
- **GET** `/api/users/:id` - 获取用户信息（userCache，30分钟）
- **GET** `/api/users` - 获取用户列表（userCache，5分钟）
- **GET** `/api/users/:id/profile` - 获取用户资料（userCache，30分钟）

#### 用户统计数据
- **GET** `/api/users/:id/stats` - 获取用户统计（statsCache，2分钟）

#### 用户帖子
- **GET** `/api/users/:id/posts` - 获取用户帖子列表（contentCache，10分钟）
- **GET** `/api/users/:id/posts/count` - 获取用户帖子数量（statsCache，2分钟）
- **GET** `/api/users/:id/posts/liked` - 获取用户点赞的帖子（contentCache，10分钟）

#### 用户社交关系
- **GET** `/api/users/:id/followers` - 获取粉丝列表（userCache，30分钟）
- **GET** `/api/users/:id/following` - 获取关注列表（userCache，30分钟）
- **GET** `/api/users/:id/followers/count` - 获取粉丝数量（statsCache，2分钟）
- **GET** `/api/users/:id/following/count` - 获取关注数量（statsCache，2分钟）

### 帖子相关接口

#### 帖子基础操作
- **GET** `/api/posts` - 获取帖子列表（contentCache，10分钟）
- **GET** `/api/posts/:id` - 获取单个帖子（contentCache，10分钟）
- **GET** `/api/posts/trending` - 获取热门帖子（contentCache，10分钟）

#### 帖子互动
- **GET** `/api/posts/:id/likes` - 获取帖子点赞列表（contentCache，10分钟）
- **GET** `/api/posts/:id/likes/count` - 获取帖子点赞数（statsCache，2分钟）

#### 帖子上传
- **POST** `/api/posts/upload` - 上传帖子图片（apiCache，5分钟）

### 活动相关接口

#### 活动列表
- **GET** `/api/activities` - 获取活动列表（contentCache，10分钟）
- **GET** `/api/activities/:id` - 获取单个活动（contentCache，10分钟）
- **GET** `/api/activities/trending` - 获取热门活动（contentCache，10分钟）
- **GET** `/api/activities/categories` - 获取活动分类（configCache，1小时）

#### 用户活动
- **GET** `/api/activities/user/:userId` - 获取用户活动（contentCache，10分钟）

---

## 🧪 前端缓存测试

### apiCache 测试用例

#### 测试1：基本缓存功能
```javascript
// 测试步骤
1. 清空浏览器缓存
2. 访问首页，观察网络请求
3. 刷新页面，验证缓存命中
4. 等待5分钟后刷新，验证缓存过期

// 预期结果
- 首次访问：发送网络请求
- 5分钟内刷新：使用缓存，无网络请求
- 5分钟后刷新：重新发送网络请求
```

#### 测试2：缓存失效机制
```javascript
// 测试步骤
1. 访问用户资料页面
2. 发布新帖子
3. 返回资料页面，验证数据更新

// 预期结果
- 发布帖子后，相关缓存自动失效
- 页面显示最新的帖子数据
```

### userDataCache 测试用例

#### 测试3：用户数据缓存
```javascript
// 测试步骤
1. 登录用户账号
2. 访问个人中心
3. 切换到其他页面再返回
4. 观察数据加载情况

// 预期结果
- 首次访问：显示加载状态
- 再次访问：立即显示缓存数据
- 控制台显示缓存命中日志
```

---

## 🔧 后端API缓存测试

### 用户模块测试

#### 测试4：用户信息缓存
```bash
# 测试命令
curl -X GET "http://localhost:3000/api/users/1" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 测试步骤
1. 第一次请求：观察响应时间
2. 立即重复请求：验证缓存命中
3. 修改用户信息
4. 再次请求：验证缓存失效

# 预期结果
- 首次请求：正常响应时间
- 缓存命中：响应时间显著减少
- 数据修改后：缓存自动失效，返回最新数据
```

#### 测试5：用户统计缓存
```bash
# 测试命令
curl -X GET "http://localhost:3000/api/users/1/stats" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 测试步骤
1. 获取用户统计数据
2. 用户发布新帖子
3. 等待2分钟（statsCache TTL）
4. 再次获取统计数据

# 预期结果
- 发布帖子后，统计数据在2分钟内保持缓存
- 2分钟后自动更新为最新统计
```

### 内容模块测试

#### 测试6：帖子列表缓存
```bash
# 测试命令
curl -X GET "http://localhost:3000/api/posts?page=1&limit=10"

# 测试步骤
1. 获取帖子列表
2. 发布新帖子
3. 立即获取帖子列表
4. 等待10分钟后再次获取

# 预期结果
- 发布新帖子后，缓存自动失效
- 列表立即显示新帖子
```

#### 测试7：热门内容缓存
```bash
# 测试命令
curl -X GET "http://localhost:3000/api/posts/trending"

# 测试步骤
1. 获取热门帖子
2. 对帖子进行点赞操作
3. 立即获取热门帖子
4. 观察排序变化

# 预期结果
- 点赞后，热门排序在缓存过期后更新
```

### 活动模块测试

#### 测试8：活动列表缓存
```bash
# 测试命令
curl -X GET "http://localhost:3000/api/activities"

# 测试步骤
1. 获取活动列表
2. 创建新活动
3. 立即获取活动列表

# 预期结果
- 创建活动后，列表缓存失效
- 新活动立即出现在列表中
```

---

## 🗑️ 缓存失效测试

### 自动失效测试

#### 测试9：TTL过期测试
```javascript
// 测试步骤
1. 访问任意缓存接口
2. 记录当前时间
3. 等待对应的TTL时间
4. 再次访问相同接口
5. 观察是否重新获取数据

// 验证方法
- 查看网络请求
- 观察响应时间变化
- 检查服务器日志
```

### 手动失效测试

#### 测试10：数据修改触发失效
```javascript
// 测试场景
1. 用户信息修改 → 用户相关缓存失效
2. 帖子发布/删除 → 帖子列表缓存失效
3. 点赞/取消点赞 → 统计缓存失效
4. 关注/取消关注 → 社交关系缓存失效

// 验证方法
- 操作前后对比数据
- 检查缓存失效日志
- 验证相关页面数据更新
```

---

## ⚡ 性能测试

### 缓存命中率测试

#### 测试11：缓存命中率统计
```bash
# 获取缓存统计
curl -X GET "http://localhost:3000/api/health/cache"

# 测试步骤
1. 执行100次随机API请求
2. 获取缓存统计信息
3. 计算命中率

# 预期结果
- 缓存命中率 > 70%
- 响应时间平均减少 > 50%
```

### 响应时间测试

#### 测试12：性能对比测试
```bash
# 使用ab工具进行压力测试
ab -n 1000 -c 10 "http://localhost:3000/api/posts"

# 测试步骤
1. 清空所有缓存
2. 执行压力测试，记录结果
3. 预热缓存
4. 再次执行压力测试
5. 对比两次结果

# 预期结果
- 缓存预热后，平均响应时间减少 > 60%
- 吞吐量提升 > 100%
```

---

## 🌍 环境配置测试

### 开发环境测试

#### 测试13：开发环境缓存行为
```javascript
// 配置验证
- userCache TTL: 5分钟
- contentCache TTL: 2分钟
- statsCache TTL: 30秒

// 测试步骤
1. 确认 NODE_ENV=development
2. 验证各缓存实例的TTL设置
3. 测试缓存过期时间

// 预期结果
- 缓存过期时间符合开发环境配置
- 便于开发调试
```

### 生产环境测试

#### 测试14：生产环境缓存行为
```javascript
// 配置验证
- userCache TTL: 30分钟
- contentCache TTL: 10分钟
- statsCache TTL: 2分钟

// 测试步骤
1. 确认 NODE_ENV=production
2. 验证各缓存实例的TTL设置
3. 测试缓存容量限制

// 预期结果
- 缓存时间更长，提升性能
- 缓存容量更大，支持更多并发
```

### 测试环境测试

#### 测试15：测试环境缓存禁用
```javascript
// 配置验证
- 所有缓存实例 enabled: false
- TTL: 1秒（如果启用）

// 测试步骤
1. 确认 NODE_ENV=test
2. 验证缓存是否被禁用
3. 确保测试结果的准确性

// 预期结果
- 缓存完全禁用或极短TTL
- 测试不受缓存影响
```

---

## 👨‍💼 管理后台缓存测试

### 用户管理测试

#### 测试16：管理员用户列表缓存
```bash
# 测试命令
curl -X GET "http://localhost:3000/api/admin/users" \
  -H "Authorization: Bearer ADMIN_TOKEN"

# 测试步骤
1. 管理员登录
2. 访问用户管理页面
3. 添加/删除用户
4. 验证列表更新

# 预期结果
- 用户列表正确缓存
- 用户变更后缓存及时失效
```

#### 测试17：用户统计仪表板缓存
```bash
# 测试命令
curl -X GET "http://localhost:3000/api/admin/dashboard" \
  -H "Authorization: Bearer ADMIN_TOKEN"

# 测试步骤
1. 访问管理后台仪表板
2. 观察统计数据加载
3. 执行影响统计的操作
4. 验证仪表板数据更新

# 预期结果
- 仪表板数据正确缓存
- 统计数据定期更新
```

### 内容管理测试

#### 测试18：内容审核缓存
```bash
# 测试命令
curl -X GET "http://localhost:3000/api/admin/posts/pending" \
  -H "Authorization: Bearer ADMIN_TOKEN"

# 测试步骤
1. 访问内容审核页面
2. 审核通过/拒绝内容
3. 验证待审核列表更新

# 预期结果
- 待审核列表正确缓存
- 审核操作后缓存失效
```

### 系统设置测试

#### 测试19：系统配置缓存
```bash
# 测试命令
curl -X GET "http://localhost:3000/api/admin/settings" \
  -H "Authorization: Bearer ADMIN_TOKEN"

# 测试步骤
1. 访问系统设置页面
2. 修改系统配置
3. 验证配置立即生效

# 预期结果
- 系统配置正确缓存
- 配置修改后全局生效
```

---

## 🚨 异常情况测试

### 缓存故障测试

#### 测试20：缓存服务异常处理
```javascript
// 模拟场景
1. 内存不足导致缓存清理
2. 缓存实例意外销毁
3. 缓存键冲突

// 测试步骤
1. 模拟异常情况
2. 观察系统行为
3. 验证降级机制

// 预期结果
- 系统继续正常运行
- 自动降级到无缓存模式
- 错误日志正确记录
```

### 缓存恢复测试

#### 测试21：缓存服务恢复
```javascript
// 测试步骤
1. 清空所有缓存
2. 重启缓存服务
3. 验证缓存重新工作

// 预期结果
- 缓存服务正常重启
- 新的缓存数据正确存储
- 性能恢复到预期水平
```

### 并发访问测试

#### 测试22：高并发缓存测试
```bash
# 使用wrk进行并发测试
wrk -t12 -c400 -d30s "http://localhost:3000/api/posts"

# 测试步骤
1. 启动高并发请求
2. 监控缓存命中率
3. 观察系统稳定性

# 预期结果
- 系统稳定运行
- 缓存命中率保持稳定
- 无内存泄漏
```

---

## 🛠️ 测试工具和方法

### 缓存调试工具

#### 开发环境专用调试接口
```bash
# 获取缓存统计
GET /api/cache-debug/stats

# 查看缓存内容
GET /api/cache-debug/inspect/:cacheType

# 清空指定缓存
DELETE /api/cache-debug/clear/:cacheType

# 缓存健康检查
GET /api/health/cache
```

#### 缓存测试接口
```bash
# 缓存功能测试
GET /api/cache-test/basic

# 缓存失效测试
POST /api/cache-invalidation-test/trigger

# 性能测试
GET /api/cache-test/performance
```

### 前端缓存监控

#### 浏览器开发者工具
```javascript
// 在控制台查看缓存统计
apiCache.getStats()
userDataCache.getCacheStats()

// 手动清理缓存
apiCache.cleanup()
userDataCache.invalidateAllCache()
```

#### 网络面板监控
```javascript
// 监控要点
1. 请求数量变化
2. 响应时间对比
3. 缓存命中标识
4. 数据一致性验证
```

### 服务器监控

#### 日志监控
```bash
# 缓存相关日志
tail -f logs/cache.log

# 性能日志
tail -f logs/performance.log

# 错误日志
tail -f logs/error.log
```

#### 内存监控
```bash
# 查看Node.js内存使用
node --inspect app.js

# 使用pm2监控
pm2 monit
```

---

## ✅ 测试检查清单

### 功能测试
- [ ] 用户注册/登录功能正常
- [ ] 个人中心数据显示正确
- [ ] 帖子发布/编辑/删除正常
- [ ] 社交功能（关注/点赞）正常
- [ ] 活动创建/参与功能正常
- [ ] 管理后台所有功能正常

### 缓存测试
- [ ] 所有缓存实例正常工作
- [ ] 缓存TTL设置正确
- [ ] 缓存失效机制正常
- [ ] 缓存命中率达标（>70%）
- [ ] 性能提升明显（>50%）

### 异常测试
- [ ] 缓存故障时系统正常降级
- [ ] 高并发下缓存稳定
- [ ] 内存使用合理，无泄漏
- [ ] 错误处理和日志记录完整

### 环境测试
- [ ] 开发环境配置正确
- [ ] 生产环境配置正确
- [ ] 测试环境缓存禁用

---

## 📊 测试报告模板

### 测试执行记录
```markdown
## 缓存功能测试报告

**测试时间**: YYYY-MM-DD HH:mm:ss
**测试环境**: development/production
**测试人员**: [姓名]

### 测试结果汇总
- 总测试用例: 22个
- 通过用例: XX个
- 失败用例: XX个
- 跳过用例: XX个

### 性能指标
- 缓存命中率: XX%
- 平均响应时间提升: XX%
- 内存使用: XX MB

### 发现问题
1. [问题描述]
   - 影响程度: 高/中/低
   - 解决方案: [方案描述]

### 建议优化
1. [优化建议]
   - 预期收益: [收益描述]
   - 实施难度: 高/中/低
```

---

## 🔄 持续监控

### 生产环境监控
```javascript
// 定期检查缓存健康状态
setInterval(() => {
  const health = getCacheHealth();
  if (health.status !== 'healthy') {
    // 发送告警
    sendAlert('缓存服务异常', health);
  }
}, 5 * 60 * 1000); // 每5分钟检查一次
```

### 性能监控
```javascript
// 监控缓存命中率
setInterval(() => {
  const stats = getAllCacheStats();
  const hitRate = calculateHitRate(stats);
  if (hitRate < 0.7) {
    // 命中率过低告警
    sendAlert('缓存命中率过低', { hitRate, stats });
  }
}, 10 * 60 * 1000); // 每10分钟检查一次
```

---

**注意事项**:
1. 测试前请确保系统处于稳定状态
2. 建议在非高峰期进行性能测试
3. 测试过程中注意监控系统资源使用
4. 发现问题及时记录并反馈开发团队
5. 定期更新测试用例，确保覆盖新功能